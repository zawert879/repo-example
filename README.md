# Docker Swarm GitOps Deployment

[![Test Init Scripts](https://github.com/zawert879/repo-example/actions/workflows/test-init.yml/badge.svg)](https://github.com/zawert879/repo-example/actions/workflows/test-init.yml)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Platform](https://img.shields.io/badge/platform-Windows%20%7C%20Linux%20%7C%20macOS-lightgrey.svg)](README.md)

–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è Docker Swarm —Å—Ç–µ–∫–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SOPS –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏ GitHub Actions –¥–ª—è CI/CD.

**üåê GitOps Ready** - —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π —á–µ—Ä–µ–∑ –≤–µ–±-—Ä–µ–¥–∞–∫—Ç–æ—Ä GitHub! –°–º. [GITOPS.md](GITOPS.md)

**üöÄ –í–∫–ª—é—á—ë–Ω –ø—Ä–∏–º–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –∏ –¥–µ–ø–ª–æ–π –≤ [example-app/](example-app/)

**‚ö° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è** - –∑–∞–ø—É—Å—Ç–∏—Ç–µ `init.ps1` –∏–ª–∏ `init.sh` –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏!

## üéØ –ë—ã—Å—Ç—Ä–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```powershell
# Windows PowerShell
.\init.ps1

# Linux/Mac
chmod +x init.sh
./init.sh
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (age, sops, gh)
- ‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SOPS Age –∫–ª—é—á
- ‚úÖ –°–æ–∑–¥–∞—Å—Ç SSH –∫–ª—é—á–∏ (ed25519 –∏–ª–∏ RSA 4096)
- ‚úÖ –ó–∞—à–∏—Ñ—Ä—É–µ—Ç –≤—Å—ë —Å –ø–æ–º–æ—â—å—é SOPS
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç GitHub secrets
- ‚úÖ –°–æ–∑–¥–∞—Å—Ç –ø–µ—Ä–≤—ã–π —Å—Ç–µ–∫ –∏–∑ —à–∞–±–ª–æ–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```powershell
.\check-status.ps1  # –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
```

### üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```powershell
# Windows
.\run-tests.ps1

# Linux/Mac
chmod +x run-tests.sh
./run-tests.sh
```

–¢–µ—Å—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç:
- ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
- ‚úÖ –ù–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- ‚úÖ GitHub Actions workflows
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: [tests/README.md](tests/README.md)

üìñ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- [TROUBLESHOOTING.md](TROUBLESHOOTING.md) - –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- [tests/README.md](tests/README.md) - üß™ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∞–º
- [GITOPS.md](GITOPS.md) - GitOps workflow
- [EXAMPLE-APP.md](EXAMPLE-APP.md) - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
.
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ deploy.yml          # GitHub Actions workflow –¥–ª—è –¥–µ–ø–ª–æ—è
‚îú‚îÄ‚îÄ stacks/                     # Docker Swarm —Å—Ç–µ–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ traefik/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ .env.encrypted      # –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
‚îÇ   ‚îî‚îÄ‚îÄ app/                    # Nginx + Postgres
‚îÇ       ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ       ‚îî‚îÄ‚îÄ .env.encrypted      # –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ø–∞—Ä–æ–ª–∏
‚îú‚îÄ‚îÄ example-app/                # üöÄ –ü—Ä–∏–º–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ .github/workflows/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ build-and-deploy.yml # –°–±–æ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.html
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ setup-github-secrets.sh # –°–∫—Ä–∏–ø—Ç –¥–ª—è Linux/Mac
‚îÇ   ‚îú‚îÄ‚îÄ setup-github-secrets.ps1# –°–∫—Ä–∏–ø—Ç –¥–ª—è Windows
‚îÇ   ‚îú‚îÄ‚îÄ encrypt-ssh.sh          # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ SSH –∫–ª—é—á–µ–π (Linux/Mac)
‚îÇ   ‚îî‚îÄ‚îÄ encrypt-ssh.ps1         # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ SSH –∫–ª—é—á–µ–π (Windows)
‚îú‚îÄ‚îÄ tests/                      # üß™ –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ test-init.ps1           # PowerShell —Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ test-init.sh            # Bash —Ç–µ—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ README.md               # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∞–º
‚îú‚îÄ‚îÄ .ssh.encrypted              # SSH –∫—Ä–µ–¥–µ–Ω—à–∏–∞–ª—ã (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã SOPS)
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ .sops.yaml                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SOPS
‚îú‚îÄ‚îÄ secrets.example.env         # –®–∞–±–ª–æ–Ω –¥–ª—è SOPS –∫–ª—é—á–∞ (–ù–ï –≤ Git)
‚îú‚îÄ‚îÄ init.ps1                    # ‚ö° –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (Windows)
‚îú‚îÄ‚îÄ init.sh                     # ‚ö° –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (Linux/Mac)
‚îú‚îÄ‚îÄ run-tests.ps1               # üß™ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ (Windows)
‚îú‚îÄ‚îÄ run-tests.sh                # üß™ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ (Linux/Mac)
‚îú‚îÄ‚îÄ check-status.ps1            # üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
‚îú‚îÄ‚îÄ README.md                   # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
‚îú‚îÄ‚îÄ GITOPS.md                   # üåê GitOps workflow guide
‚îú‚îÄ‚îÄ EXAMPLE-APP.md              # üì¶ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è example-app
‚îî‚îÄ‚îÄ TROUBLESHOOTING.md          # üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SOPS

**Linux/Mac:**
```bash
# –ò—Å–ø–æ–ª—å–∑—É—è Homebrew
brew install sops

# –ò–ª–∏ —Å–∫–∞—á–∞—Ç—å –≤—Ä—É—á–Ω—É—é
wget https://github.com/mozilla/sops/releases/download/v3.8.1/sops-v3.8.1.linux.amd64
sudo mv sops-v3.8.1.linux.amd64 /usr/local/bin/sops
sudo chmod +x /usr/local/bin/sops
```

**Windows:**
```powershell
# –ò—Å–ø–æ–ª—å–∑—É—è Chocolatey
choco install sops

# –ò–ª–∏ —Å–∫–∞—á–∞—Ç—å –≤—Ä—É—á–Ω—É—é —Å GitHub
```

### 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Age –∫–ª—é—á–∞ –¥–ª—è SOPS

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ age
brew install age  # Mac
# –∏–ª–∏
apt-get install age  # Linux

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞
age-keygen -o key.txt

# –í—ã–≤–æ–¥ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞
cat key.txt | grep "public key:"
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ:
- **–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á** (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `AGE-SECRET-KEY-1...`) –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ
- **–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á** (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `age1...`) –¥–æ–±–∞–≤—å—Ç–µ –≤ `.sops.yaml`

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SOPS

–û—Ç–∫—Ä–æ–π—Ç–µ `.sops.yaml` –∏ –∑–∞–º–µ–Ω–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ –≤–∞—à:

```yaml
creation_rules:
  - path_regex: \.env\.encrypted$
    age: >-
      age1–≤–∞—à_–ø—É–±–ª–∏—á–Ω—ã–π_–∫–ª—é—á_–∑–¥–µ—Å—å
  - path_regex: \.ssh\.encrypted$
    age: >-
      age1–≤–∞—à_–ø—É–±–ª–∏—á–Ω—ã–π_–∫–ª—é—á_–∑–¥–µ—Å—å
```

### 4. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ SSH –∫—Ä–µ–¥–µ–Ω—à–∏–∞–ª–æ–≤

SSH –∫—Ä–µ–¥–µ–Ω—à–∏–∞–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ:

```bash
# –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª —Å SSH –¥–∞–Ω–Ω—ã–º–∏
cat > .ssh << EOF
SSH_PRIVATE_KEY="-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmU...
-----END OPENSSH PRIVATE KEY-----"
SSH_HOST="192.168.1.100"
SSH_USERNAME="deploy"
SSH_PORT="22"
EOF

# –ó–∞—à–∏—Ñ—Ä—É–π—Ç–µ –µ–≥–æ
sops -e .ssh > .ssh.encrypted
rm .ssh

# –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è SSH –∫—Ä–µ–¥–µ–Ω—à–∏–∞–ª–æ–≤
sops .ssh.encrypted
```

### 5. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å—Ç–µ–∫–æ–≤

–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–µ–∫–∞ —Å–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª –∏ –∑–∞—à–∏—Ñ—Ä—É–π—Ç–µ –µ–≥–æ:

```bash
# –ü—Ä–∏–º–µ—Ä –¥–ª—è Traefik
cd stacks/traefik
cat > .env << EOF
ACME_EMAIL=admin@example.com
TRAEFIK_DOMAIN=traefik.example.com
TRAEFIK_AUTH=admin:\$apr1\$H6uskkkW\$IgXLP6ewTrSuBkTrqE8wj/
EOF

# –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
sops -e .env > .env.encrypted
rm .env

# –ü—Ä–∏–º–µ—Ä –¥–ª—è App (Nginx + Postgres)
cd ../app
cat > .env << EOF
NGINX_DOMAIN=example.com
POSTGRES_DB=myapp
POSTGRES_USER=admin
POSTGRES_PASSWORD=super_secret_password_123
EOF

sops -e .env > .env.encrypted
rm .env
```

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Basic Auth –ø–∞—Ä–æ–ª—è –¥–ª—è Traefik:**
```bash
echo $(htpasswd -nb admin your_password)
```

### 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Secrets

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `secrets.env` –Ω–∞ –æ—Å–Ω–æ–≤–µ `secrets.example.env`:

```bash
cp secrets.example.env secrets.env
```

–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ SOPS Age –∫–ª—é—á:
```bash
SOPS_AGE_KEY=AGE-SECRET-KEY-1–≤–∞—à_–ø—Ä–∏–≤–∞—Ç–Ω—ã–π_–∫–ª—é—á
```

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

**Linux/Mac:**
```bash
chmod +x scripts/setup-github-secrets.sh
./scripts/setup-github-secrets.sh
```

**Windows PowerShell:**
```powershell
Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
.\scripts\setup-github-secrets.ps1
```

**‚ö†Ô∏è –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª `secrets.env`!**

```bash
rm secrets.env
```

### 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Swarm –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–ù–∞ –≤–∞—à–µ–º —Å–µ—Ä–≤–µ—Ä–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ Docker Swarm:

```bash
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Swarm
docker swarm init

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –¥–ª—è Postgres (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
docker node update --label-add postgres=true $(docker node ls -q)
```

## üì¶ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å—Ç–µ–∫–æ–≤

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ (GitOps)

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `stacks/` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è GitHub Actions workflow:

1. **–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Å—Ç–µ–∫–∏** - –¥–µ–ø–ª–æ–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç SOPS
3. –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç SSH –∫—Ä–µ–¥–µ–Ω—à–∏–∞–ª—ã –∏–∑ `.ssh.encrypted`
4. –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç `.env.encrypted` —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Å—Ç–µ–∫–æ–≤
5. –ö–æ–ø–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ SSH
6. –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Å—Ç–µ–∫–∏ —á–µ—Ä–µ–∑ `docker stack deploy`

**–ü—Ä–∏–º–µ—Ä—ã:**
- –ò–∑–º–µ–Ω–∏–ª–∏ `stacks/traefik/docker-compose.yml` ‚Üí –¥–µ–ø–ª–æ–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ Traefik
- –ò–∑–º–µ–Ω–∏–ª–∏ `stacks/app/.env.encrypted` ‚Üí –¥–µ–ø–ª–æ–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ App
- –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ workflow ‚Üí –¥–µ–ø–ª–æ—è—Ç—Å—è –≤—Å–µ —Å—Ç–µ–∫–∏

### üåê GitOps —á–µ—Ä–µ–∑ –≤–µ–±-—Ä–µ–¥–∞–∫—Ç–æ—Ä GitHub

**–î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å GitHub:**

1. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ github.com** –≤ –≤–∞—à —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
2. **–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**, –Ω–∞–ø—Ä–∏–º–µ—Ä `stacks/app/docker-compose.yml`
3. **–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** (–∏–∫–æ–Ω–∫–∞ –∫–∞—Ä–∞–Ω–¥–∞—à–∞)
4. **–í–Ω–µ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**, –Ω–∞–ø—Ä–∏–º–µ—Ä:
   ```yaml
   nginx:
     deploy:
       replicas: 3  # –ë—ã–ª–æ: 2
   ```
5. **Commit changes** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –¥–µ–ø–ª–æ–π!

**–ß—Ç–æ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —á–µ—Ä–µ–∑ –≤–µ–±:**
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ `docker-compose.yml`
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–ø–ª–∏–∫
- ‚úÖ –õ–∏–º–∏—Ç—ã —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ –í–µ—Ä—Å–∏–∏ –æ–±—Ä–∞–∑–æ–≤
- ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚ùå –°–µ–∫—Ä–µ—Ç—ã (—Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ SOPS)

**–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ:** [GITOPS.md](GITOPS.md)

### –†—É—á–Ω–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ (–ª–æ–∫–∞–ª—å–Ω–æ)

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /path/to/stacks

# Traefik (—Å–Ω–∞—á–∞–ª–∞!)
export $(sops -d traefik/.env.encrypted | xargs)
docker stack deploy -c traefik/docker-compose.yml traefik

# App (Nginx + Postgres)
export $(sops -d app/.env.encrypted | xargs)
docker stack deploy -c app/docker-compose.yml app
```

## üîê –†–∞–±–æ—Ç–∞ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)

–°–µ–∫—Ä–µ—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ —Å –ø–æ–º–æ—â—å—é SOPS:

```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ SOPS
sops stacks/app/.env.encrypted
sops .ssh.encrypted

# –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è - commit –∏ push
git add stacks/app/.env.encrypted
git commit -m "Update database password"
git push  # ‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π!
```

## üîß –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–µ–∫–æ–≤

### Traefik (`stacks/traefik/`)
- Reverse proxy –∏ load balancer
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –æ—Ç Let's Encrypt
- Dashboard —Å Basic Auth –∑–∞—â–∏—Ç–æ–π
- –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### App (`stacks/app/`)
–û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π —Å—Ç–µ–∫ —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏:

**Nginx:**
- –í–µ–±-—Å–µ—Ä–≤–µ—Ä
- 2 —Ä–µ–ø–ª–∏–∫–∏ –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Traefik
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π SSL

**Postgres:**
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL 15
- –ü–∞—Ä–æ–ª–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ SOPS
- Persistent storage
- –†–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –Ω–æ–¥–µ

## üõ† –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–µ–∫–æ–≤
docker stack ls

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–µ—Ä–≤–∏—Å–æ–≤ —Å—Ç–µ–∫–∞
docker stack services traefik
docker stack services app

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker service logs -f traefik_traefik
docker service logs -f app_nginx
docker service logs -f app_postgres

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–µ–∫–∞
docker stack rm app
```

### üåê GitOps: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≤–µ–±

**–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ `stacks/app/docker-compose.yml` –Ω–∞ GitHub
2. –ù–∞–π–¥–∏—Ç–µ `nginx` ‚Üí `deploy` ‚Üí `replicas`
3. –ò–∑–º–µ–Ω–∏—Ç–µ `replicas: 2` ‚Üí `replicas: 3`
4. Commit ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π!

**–î—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –≤–µ–±:**
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π –æ–±—Ä–∞–∑–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Ä–µ—Å—É—Ä—Å–æ–≤
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ:** [GITOPS.md](GITOPS.md)

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç —Å Example App

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ GitOps –≤ –¥–µ–π—Å—Ç–≤–∏–∏:

```bash
# 1. –ò–∑–º–µ–Ω–∏—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç
vim example-app/src/index.html

# 2. Commit –∏ push
git add example-app/src/index.html
git commit -m "Update homepage"
git push

# 3. GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
#    - –°–æ–±–µ—Ä—ë—Ç Docker –æ–±—Ä–∞–∑
#    - –ó–∞–ø—É—à–∏—Ç –≤ GHCR
#    - –°–æ–∑–¥–∞—Å—Ç PR —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π

# 4. Merge PR ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π!
```

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: [example-app/README.md](example-app/README.md)

## üîÑ –ü–µ—Ä–µ–¥–∞—á–∞ –¥–æ—Å—Ç—É–ø–∞ –¥—Ä—É–≥–æ–º—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É

–î–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é –¥—Ä—É–≥–æ–º—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å **—Ç–æ–ª—å–∫–æ SOPS Age –∫–ª—é—á**:

```bash
# –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (–±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º!)
cat ~/.config/sops/age/keys.txt
```

–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–æ–∂–µ—Ç:
- –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—Ç—å –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
- –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—Ç—å SSH –∫—Ä–µ–¥–µ–Ω—à–∏–∞–ª—ã
- –î–µ–ø–ª–æ–∏—Ç—å —Å—Ç–µ–∫–∏ –≤—Ä—É—á–Ω—É—é
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

**–ù–∏–∫–∞–∫–∏–µ –¥—Ä—É–≥–∏–µ —Å–µ–∫—Ä–µ—Ç—ã –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ!**

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

### –°–æ–∑–¥–∞–Ω–∏–µ SSH –∫–ª—é—á–∞ –¥–ª—è –¥–µ–ø–ª–æ—è

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
ssh-keygen -t ed25519 -C "deploy@github-actions" -f ~/.ssh/deploy_key

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh-copy-id -i ~/.ssh/deploy_key.pub user@your-server

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ .ssh –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
cat ~/.ssh/deploy_key
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ GitHub Secrets

```bash
# –ò—Å–ø–æ–ª—å–∑—É—è GitHub CLI
gh secret list
```

### –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

```bash
# SSH –∫—Ä–µ–¥–µ–Ω—à–∏–∞–ª—ã
sops .ssh.encrypted

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–µ–∫–∞
sops stacks/traefik/.env.encrypted
sops stacks/app/.env.encrypted
```

## üêõ Troubleshooting

**–ü—Ä–æ–±–ª–µ–º–∞:** SOPS –Ω–µ –º–æ–∂–µ—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
export SOPS_AGE_KEY_FILE=~/.config/sops/age/keys.txt
# –ò–ª–∏
export SOPS_AGE_KEY="AGE-SECRET-KEY-1..."
```

**–ü—Ä–æ–±–ª–µ–º–∞:** Docker stack deploy –Ω–µ –≤–∏–¥–∏—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
export $(sops -d .env.encrypted | xargs)
env | grep POSTGRES  # –ü—Ä–æ–≤–µ—Ä–∫–∞
```

**–ü—Ä–æ–±–ª–µ–º–∞:** GitHub Actions –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ SSH
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .ssh.encrypted —Ñ–∞–π–ª
sops -d .ssh.encrypted

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ docker
sudo usermod -aG docker your-user
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–µ–ø–ª–æ—è—Ç—Å—è –≤—Å–µ —Å—Ç–µ–∫–∏ –≤–º–µ—Å—Ç–æ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö
```bash
# Workflow –¥–µ–ø–ª–æ–∏—Ç –≤—Å–µ —Å—Ç–µ–∫–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ
# –ü—Ä–∏ push –¥–µ–ø–ª–æ—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Å—Ç–µ–∫–∏ –≤ stacks/
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—ã –∏–∑–º–µ–Ω–∏–ª–∏ —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ stacks/
```

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

## ü§ù Contribution

Pull requests –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è!

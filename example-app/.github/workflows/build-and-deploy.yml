name: Build and Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'Dockerfile'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version
        id: version
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π hash –∫–æ–º–º–∏—Ç–∞
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          # –ü–æ–ª—É—á–∞–µ–º timestamp –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYYMMDD-HHMMSS
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –≤–µ—Ä—Å–∏—é: timestamp-hash
          VERSION="${TIMESTAMP}-${SHORT_SHA}"
          
          # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–≥, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
          if git describe --tags --exact-match 2>/dev/null; then
            TAG_VERSION=$(git describe --tags --exact-match)
            echo "tag_version=${TAG_VERSION}" >> $GITHUB_OUTPUT
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  update-deploy-repo:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout deployment repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.DEPLOY_REPO }}
          token: ${{ secrets.DEPLOY_REPO_TOKEN }}
          ref: main

      - name: Update image version in docker-compose
        run: |
          VERSION="${{ needs.build-and-push.outputs.version }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION"
          
          echo "Updating to version: $VERSION"
          echo "New image: $IMAGE"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑ nginx –≤ stacks/app/docker-compose.yml
          # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å image: ghcr.io/.../example-app –∏ –∑–∞–º–µ–Ω—è–µ–º
          sed -i "s|image: ghcr.io/.*/example-app:.*|image: $IMAGE|g" stacks/app/docker-compose.yml
          
          # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ (–ø–µ—Ä–≤—ã–π —Ä–∞–∑), –∑–∞–º–µ–Ω—è–µ–º nginx:alpine
          if ! grep -q "example-app:" stacks/app/docker-compose.yml; then
            sed -i "s|image: nginx:alpine|image: $IMAGE|g" stacks/app/docker-compose.yml
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git diff stacks/app/docker-compose.yml

          body: |
            ## Automatic Update
            
            This PR updates the example-app to version **${{ needs.build-and-push.outputs.version }}**
            
            ### üì¶ Docker Images
            
            The following tags are available:
            - `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.version }}` (timestamp-hash)
            ### üì¶ Docker Images
            
            - `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.version }}`
            - `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest`
            - **Branch:** ${{ github.ref_name }}
            - **Workflow:** ${{ github.workflow }}
            
            ### üìù Changes
            Check the [commit history](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) for details.
            
            ### üöÄ Deployment
          branch: update-app-${{ github.sha }}
          delete-branch: true
          labels: |
            automated
            deployment
            example-app was created automatically by GitHub Actions
            ### Deployment
            After merging this PR, the new version will be automatically deployed to production via GitOps workflow.
            
            ---
            
            ü§ñ This PR was created automatically by GitHub Actions
          branch: update-app-${{ needs.build-and-push.outputs.version }}
          delete-branch: true
          labels: |
            automated
            deployment
